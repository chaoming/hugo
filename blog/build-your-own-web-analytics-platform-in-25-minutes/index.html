<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Building a simple web analytics data pipeline on AWS can be a fun project for anyone who wants to learn about data pipelines."><title>Build Your Own Web Analytics Platform in 25 Minutes</title><link rel=canonical href=https://chaoming.li/blog/build-your-own-web-analytics-platform-in-25-minutes/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="Build Your Own Web Analytics Platform in 25 Minutes"><meta property="og:description" content="Building a simple web analytics data pipeline on AWS can be a fun project for anyone who wants to learn about data pipelines."><meta property="og:url" content="https://chaoming.li/blog/build-your-own-web-analytics-platform-in-25-minutes/"><meta property="og:site_name" content="Chaoming's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="aws"><meta property="article:tag" content="cloudfront"><meta property="article:tag" content="s3"><meta property="article:tag" content="google tag manager"><meta property="article:tag" content="gtm"><meta property="article:tag" content="athena"><meta property="article:tag" content="sql"><meta property="article:tag" content="web analytics"><meta property="article:published_time" content="2018-02-20T00:00:00+00:00"><meta property="article:modified_time" content="2018-02-20T00:00:00+00:00"><meta property="og:image" content="https://chaoming.li/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427.png"><meta name=twitter:site content="@ChaomingLi"><meta name=twitter:creator content="@ChaomingLi"><meta name=twitter:title content="Build Your Own Web Analytics Platform in 25 Minutes"><meta name=twitter:description content="Building a simple web analytics data pipeline on AWS can be a fun project for anyone who wants to learn about data pipelines."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chaoming.li/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-MY4GMY6ZN6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MY4GMY6ZN6",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hucfd1e4e1e923fa2ea65408b850fbf57c_3588_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Chaoming's Blog</a></h1><h2 class=site-description>Tech entrepreneur, CEO of Insightech.</h2></div></header><ol class=social-menu><li><a href=https://github.com/chaoming target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/chaomingli/ target=_blank title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://twitter.com/ChaomingLi target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/projects/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Projects</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/build-your-own-web-analytics-platform-in-25-minutes/><img src=/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427_hub4d3af91cee52a79943037e924e82338_245585_800x0_resize_box_3.png srcset="/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427_hub4d3af91cee52a79943037e924e82338_245585_800x0_resize_box_3.png 800w, /blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427_hub4d3af91cee52a79943037e924e82338_245585_1600x0_resize_box_3.png 1600w" width=800 height=445 loading=lazy alt="Featured image of post Build Your Own Web Analytics Platform in 25 Minutes"></a></div><div class=article-details><header class=article-category><a href=/categories/big-data/>Big Data</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/build-your-own-web-analytics-platform-in-25-minutes/>Build Your Own Web Analytics Platform in 25 Minutes</a></h2><h3 class=article-subtitle>Building a simple web analytics data pipeline on AWS can be a fun project for anyone who wants to learn about data pipelines.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 20, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p>I gave a presentation in MeasureCamp Melbourne, and the topic was “Build Your Own Web Analytics Platform in 25 Minutes”. In MeasureCamp, each session has 25 minutes of presentation time, that’s where the 25 minutes on the topic from. What inspired me to do this talk was a conversation in Measure Slack about sending Google Analytics data into your own database. And I think it is an interesting thing to do to build a web analytics platform from scratch without spending a lot of time and money.</p><p>Building your own web analytics platform can be much simpler than you would think. In this presentation, there is pretty much no coding knowledge required. If you are familiar with AWS S3 and CloudFront, it is very simple. If not, don’t worry, AWS has a really good interface so you just need to click through a series of buttons. Below is the high-level architecture of the platform. Option #1 was something I built in my previous job for production support. It was not based on any cloud so it was able to store personally identifiable information (PII) and the production support team used it to help to recreate scenarios for debugging. Option #2 is the solution in this presentation, which uses AWS cloud so all the infrastructure can be set up in minutes. You will need to have an AWS account to do it. You can <a class=link href=https://aws.amazon.com/free/ target=_blank rel=noopener>sign up for a free account here</a>.</p><p>The whole process includes 8 steps. I will go through all the 8 steps here.</p><p><img src=/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427.png width=768 height=427 srcset="/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427_hub4d3af91cee52a79943037e924e82338_245585_480x0_resize_box_3.png 480w, /blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-19-46-41_orig-768x427_hub4d3af91cee52a79943037e924e82338_245585_1024x0_resize_box_3.png 1024w" loading=lazy alt="Simple Web Analytics System Architecture" class=gallery-image data-flex-grow=179 data-flex-basis=431px></p><h2 id=step-1-create-an-s3-bucket-to-store-log-files>Step 1: Create an S3 bucket to store log files</h2><p>First of all, you will need an S3 bucket to store all the log files. AWS S3 is a storage service, where you can store a lot of files in the cloud with pretty low costs. S3 buckets are like folders, you can store a group of files within.</p><p>Login to your AWS account, click on S3 in the product list menu under the Storage section and click on Create Bucket button. Give a name to the bucket, something like “my-web-analytics-logs”, and click Next all the way through. You have your S3 bucket created now.</p><h2 id=step-2-create-an-s3-bucket-to-store-the-tracking-pixel-image>Step 2: Create an S3 bucket to store the tracking pixel image</h2><p>Most web analytics solutions are using an invisible pixel image to track data. They attach the information to be tracked in the pixel URL as query parameters. So we need an S3 bucket to host this pixel file. Just repeat the process of step 1, but name the bucket “my-web-analytics-pixel”. Upload the pixel file to the bucket. You can grab the pixel file from <a class=link href=https://s3.amazonaws.com/cli-tracking-demo-pixel/pixel.gif target=_blank rel=noopener>https://s3.amazonaws.com/cli-tracking-demo-pixel/pixel.gif</a></p><p>You will need to make the pixel file public so it can be accessed from the Internet. To do so, go to the pixel bucket and tick the checkbox next to the file name, click More and select Make Public.</p><h2 id=step-3-create-a-cloudfront-distribution-and-enable-logging>Step 3: Create a CloudFront distribution and enable logging</h2><p>Now, we have our pixel file in the cloud, and we are ready to store the log files. CloudFront is the CDN AWS offers. It is fast and cheap to run. The reason we want to use CloudFront here is to be able to serve the pixel file very fast, so it doesn’t impact the page performance much, and log the data at the same time. Go to CloudFront, click on Create Distribution button, and click on Get Started under the Web section to go to the form to create a distribution.</p><p>When you create the CloudFront distribution, you will need to enable logging and point to log files to the S3 bucket we created in step 1.</p><p>You will also need to point the origin to the S3 bucket containing the pixel file so your CloudFront distribution can serve the pixel file. You can leave all the other options as default.</p><p>After these 3 steps are completed, you are ready to take in whatever data and store it. We should start to work on the part to generate data.</p><h2 id=step-4-create-a-visitor-id-via-gtm>Step 4: Create a visitor ID via GTM</h2><p>To track the same visitors across a period, you need a cookie to store a unique random visitor ID. In Google Tag Manager (GTM), go to Variables, and create a custom Javascript variable and name it “Visitor ID”. Copy and paste the code below to the variable. This piece of code will check if the visitor already has a visitor ID cookie “v_id”. If yes, it will read it, refresh the cookie for another 2 years, and return the visitor ID value. Otherwise, it will create a random ID and save it to “v_id” cookie for 2 years, and return the newly created visitor ID value. We will use this value in the next step.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>readCookie</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=nx>result</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=s1>&#39;(?:^|; )&#39;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;=([^;]*)&#39;</span><span class=p>).</span><span class=nx>exec</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span><span class=p>))</span> <span class=o>?</span> <span class=p>(</span><span class=nx>result</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>writeCookie</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>domain</span><span class=p>,</span> <span class=nx>expire</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span> <span class=o>=</span> <span class=nx>name</span><span class=o>+</span><span class=s2>&#34;=&#34;</span><span class=o>+</span><span class=nx>value</span><span class=o>+</span><span class=s2>&#34;;domain=.&#34;</span><span class=o>+</span><span class=nx>domain</span><span class=o>+</span><span class=s2>&#34;;path=/;expires=&#34;</span><span class=o>+</span><span class=nx>expire</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>visitorId</span> <span class=o>=</span> <span class=nx>readCookie</span><span class=p>(</span><span class=s1>&#39;v_id&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>date</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>visitorId</span> <span class=o>===</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>visitorId</span> <span class=o>=</span> <span class=nx>date</span><span class=p>.</span><span class=nx>getTime</span><span class=p>().</span><span class=nx>toString</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=p>(</span><span class=mi>999999</span> <span class=o>-</span> <span class=mi>100000</span><span class=p>)</span> <span class=o>+</span> <span class=mi>100000</span><span class=p>)).</span><span class=nx>toString</span><span class=p>(</span><span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>date</span><span class=p>.</span><span class=nx>setTime</span><span class=p>(</span><span class=nx>date</span><span class=p>.</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>+</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=mi>365</span> <span class=o>*</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nx>writeCookie</span><span class=p>(</span><span class=s1>&#39;v_id&#39;</span><span class=p>,</span> <span class=nx>visitorId</span><span class=p>,</span> <span class=nx>location</span><span class=p>.</span><span class=nx>hostname</span><span class=p>,</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=nx>date</span><span class=p>).</span><span class=nx>toUTCString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>visitorId</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=step-5-create-an-image-tag-in-gtm-and-attach-data-in-the-url-query-parameters>Step 5: Create an image tag in GTM and attach data in the URL query parameters</h2><p>We are going to use the pixel file in this step. Create an image tag in GTM. In the URL field, put in “https://your-cloud-front-distribution.cloudfront.net/pixel.gif?vid={{Visitor ID}}&pageUrl={{Page URL}}”, set the trigger as All Pages. <code>{{Visitor ID}}</code> is the variable created in the previous step, and I attached the page URL in the query parameters in this example but you can attach whatever variables in your GTM as key-value pairs in the same way.</p><p><img src=/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-29-52_orig-768x337.png width=768 height=337 srcset="/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-29-52_orig-768x337_hu75cd23ab8fc84cb5aa7db0dae4db8789_88175_480x0_resize_box_3.png 480w, /blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-29-52_orig-768x337_hu75cd23ab8fc84cb5aa7db0dae4db8789_88175_1024x0_resize_box_3.png 1024w" loading=lazy alt="Google Tag Manager Custom Tag" class=gallery-image data-flex-grow=227 data-flex-basis=546px></p><h2 id=step-6-publish-gtm>Step 6: Publish GTM</h2><p>By now, all the data collection and storage is set up. Once you publish GTM to your websites, data will start to flow in soon. The way it is set up in this demo doesn’t support real-time data streaming, so you will need to wait a few minutes to have your first log file deposited in the S3 bucket.</p><h2 id=step-7-create-an-athena-table-schema>Step 7: Create an Athena table schema</h2><p>After the data files are in your S3 bucket, you can start to query the data. AWS Athena is probably the fastest way to do so if you like to use SQL. I prefer to create a table manually in Athena than using the crawler feature because I found the crawler is not always working properly in my experience.</p><p>To manually create a table in Athena, you will need to point the table to your log file s3 bucket and define all the fields in the table. You can find <a class=link href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html target=_blank rel=noopener>the CloudFront log file format here</a>. There are 25 fields, so take your time to go through them one by one. In my demo, I only created the first 12 fields because that’s good enough for the demo, and the 12th field is the one stores the query parameter data. Here is a screenshot of the fields in my table.</p><p><img src=/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-39-40_orig-768x381.png width=768 height=381 srcset="/blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-39-40_orig-768x381_hu62c2c7d44b1a4583eaabf69077b16cd4_114345_480x0_resize_box_3.png 480w, /blog/build-your-own-web-analytics-platform-in-25-minutes/screenshot-2018-02-24-20-39-40_orig-768x381_hu62c2c7d44b1a4583eaabf69077b16cd4_114345_1024x0_resize_box_3.png 1024w" loading=lazy alt="AWS Athena Data Schema" class=gallery-image data-flex-grow=201 data-flex-basis=483px></p><h2 id=step-8-check-your-data><strong>S</strong>tep 8: Check your data</h2><p>You can use “select * from database_name.table_name” to inspect all the data you have in the log files. Spend some time learning your data, you have the IP address, the user agent string, and the data you send through from the pixel.</p><p>Here is the SQL to count visitors by page URLs and sort the results in descending order. The example uses the <code>url_extract_parameter</code> function to get the value out of the query parameters by name. This function only works for full URLs, so I have to concatenate some fields to recreate the full URLs to allow the function to work properly,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>VisitorID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Visitors</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>PageUrl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>url_extract_parameter</span><span class=p>(</span><span class=n>RequestURL</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;vid&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>VisitorID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>url_decode</span><span class=p>(</span><span class=n>url_extract_parameter</span><span class=p>(</span><span class=n>RequestURL</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;url&#39;</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>PageUrl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=s1>&#39;https://&#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&#34;cs-host&#34;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&#34;cs-uri-stem&#34;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39;?&#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&#34;cs-uri-query&#34;</span><span class=w>  </span><span class=k>AS</span><span class=w> </span><span class=n>RequestURL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=s2>&#34;webanalytics&#34;</span><span class=p>.</span><span class=s2>&#34;logs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>PageUrl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>Visitors</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>By now, you have a very simple web analytics platform that can take in whatever data you want to track as long as you have it in your GTM variables. This is just a super-simplified demo of how web analytics platforms work in principle. There are a lot of missing parts such as cross-domain tracking, data enrichment, data visualisation, etc. However, it is also very flexible because it is not limited by any platform. You have the freedom to design what to track.</p><p>I hope this article helps you understand how web analytics platform collects data at a high level, and feel free to extend it to other usages like tracking non-web data.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/aws/>aws</a>
<a href=/tags/cloudfront/>cloudfront</a>
<a href=/tags/s3/>s3</a>
<a href=/tags/google-tag-manager/>google tag manager</a>
<a href=/tags/gtm/>gtm</a>
<a href=/tags/athena/>athena</a>
<a href=/tags/sql/>sql</a>
<a href=/tags/web-analytics/>web analytics</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/joining-partitioned-tables-to-create-views-in-bigquery/><div class=article-image><img src=/blog/joining-partitioned-tables-to-create-views-in-bigquery/bigquery-500x250.4ab5a40f0871bcee044d45191d39bc64_hu38b1e2727a49b2316807e11208821041_104204_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Joining Partitioned Tables to Create Views in BigQuery" data-hash="md5-SrWkDwhxvO4ETUUZHTm8ZA=="></div><div class=article-details><h2 class=article-title>Joining Partitioned Tables to Create Views in BigQuery</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//chaomings-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Chaoming's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#step-1-create-an-s3-bucket-to-store-log-files>Step 1: Create an S3 bucket to store log files</a></li><li><a href=#step-2-create-an-s3-bucket-to-store-the-tracking-pixel-image>Step 2: Create an S3 bucket to store the tracking pixel image</a></li><li><a href=#step-3-create-a-cloudfront-distribution-and-enable-logging>Step 3: Create a CloudFront distribution and enable logging</a></li><li><a href=#step-4-create-a-visitor-id-via-gtm>Step 4: Create a visitor ID via GTM</a></li><li><a href=#step-5-create-an-image-tag-in-gtm-and-attach-data-in-the-url-query-parameters>Step 5: Create an image tag in GTM and attach data in the URL query parameters</a></li><li><a href=#step-6-publish-gtm>Step 6: Publish GTM</a></li><li><a href=#step-7-create-an-athena-table-schema>Step 7: Create an Athena table schema</a></li><li><a href=#step-8-check-your-data><strong>S</strong>tep 8: Check your data</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>